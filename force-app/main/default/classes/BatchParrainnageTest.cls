@isTest
public without sharing class BatchParrainnageTest {
	@isTest
	public static void testfilleul() {

		ID RTCodePostal = [SELECT Id FROM RecordType WHERE DeveloperName = 'CP_Ville' LIMIT 1].Id;
        ID RTComptePro = [SELECT Id FROM RecordType WHERE DeveloperName = 'Compte_Professionnel' LIMIT 1].Id; 
        ID RTNAF = [SELECT Id FROM RecordType WHERE DeveloperName = 'NAF_Libelle' LIMIT 1].Id;
        ID RTPays = [SELECT Id FROM RecordType WHERE DeveloperName = 'Pays' LIMIT 1].Id;
        ID RTCompetence = [SELECT Id FROM RecordType WHERE DeveloperName = 'Competence' LIMIT 1].Id;

        Reference__c NAF = new Reference__c(RecordTypeId = RTNAF, Code__c = 'AAA', Name = 'Activite');
        insert NAF;

        Reference__c NAF1 = new Reference__c(RecordTypeId = RTNAF, Code__c = 'BBB', Name = 'Activiteb');
        insert NAF1;
        
        Reference__c FR = new Reference__c(RecordTypeId = RTPays, Name = 'France', key__c = 'FRA');
        insert FR;
        
        Reference__c CP = new Reference__c(RecordTypeId = RTCodePostal, Code__c = '75001', Name = 'Paris');
        insert CP;

        Account parrain = new Account(RecordTypeId = RTComptePro, Name = 'Test account', SIRET_texte__c = '32212091600208', Phone = '+33635136116', Statut_global__c = 'CLIENT',
                                        Pays_LKP__c = FR.id, Code_postal__c = CP.Id,
                                        Code_NAF_APE_societe_declarante__c = NAF.Id);
        insert parrain;
        system.debug('TEST parrain contenu  =' + parrain);
        Account filleul = new Account(RecordTypeId = RTComptePro, Name = 'T', SIRET_texte__c = '02212091600207', Phone = '+33635136117', Statut_global__c = 'CLIENT',
                                        Pays_LKP__c = FR.id, Code_postal__c = CP.Id,
                                        Code_NAF_APE_societe_declarante__c = NAF1.Id, code_client__c='B0000');
        system.debug('TEST filleul contenu  =' + filleul);
        insert filleul;
        system.debug('TEST filleul contenu  =' + filleul);

        Contact ctc = new Contact(Salutation = 'M', FirstName = 'Contact', LastName = 'Test', Contact_Principal_O_N__c = true, Contact_de_facturation__c = true, 
                                        AccountId = parrain.Id, DoNotCall = true, Phone = '+33111111111', Email='a@b.c');
        insert ctc;

        parrain.contact_principal__c=ctc.id;
        filleul.contact_principal__c=ctc.id;

        update parrain;

        update filleul;

        Zuora__Subscription__c Subscription = new Zuora__Subscription__c(Name='A-S00006123',Zuora__MRR__c = 26.25, Zuora__Status__c = 'Active',Zuora__Version__c=1,Zuora__TermStartDate__c=system.today(),Zuora__SubscriptionStartDate__c=system.today(),Zuora__ContractEffectiveDate__c=system.today() ,Zuora__Account__c = parrain.Id);
       
        insert Subscription;

        filleul.Parrain__c = parrain.Id;
        update filleul;

        Zuora__Subscription__c Subscriptionf = new Zuora__Subscription__c(Name='A-S00009456',Zuora__MRR__c = 26.25, Zuora__Status__c = 'Active',Zuora__Version__c=1,Zuora__TermStartDate__c=system.today(),Zuora__SubscriptionStartDate__c=system.today().addMonths(-1),Zuora__ContractEffectiveDate__c=system.today() ,Zuora__Account__c = filleul.Id);
       
        insert Subscriptionf;

        test.startTest();
        Test.setMock(HttpCalloutMock.class, new MockHttpResponse200());
        BatchParrainnage  b = new  BatchParrainnage(); 
       	database.executebatch(b,5);
        test.stopTest();
	}

    public class MockHttpResponse200 implements HttpCalloutMock {
    // Implement this interface method
        public HTTPResponse respond(HttpRequest req) {
        
            // Create a fake response
            HttpResponse res = new HttpResponse();
            res.setHeader('Content-Type', 'application/pdf;charset=UTF-8');
            res.setBody(jsonExemple());
            res.setStatusCode(200);
            return res;
        }
        
        public String jsonExemple() {
        String json = '{  "success" : true,  "id" : "2c92c0fb5fbecca6015fc0268a755a77",  "accountId" : "2c92c0f95fa60acc015fb600930f5221",  "accountNumber" : "09PRS",  "accountName" : "test_sgo_13112017",  "subscriptionNumber" : "A-S00000981",  "termType" : "EVERGREEN",  "invoiceSeparately" : false,  "contractEffectiveDate" : "2017-11-13",  "serviceActivationDate" : "2017-11-13",  "customerAcceptanceDate" : "2017-11-13",  "subscriptionStartDate" : "2017-11-13",  "termStartDate" : "2017-11-13",  "termEndDate" : null,  "initialTerm" : null,  "initialTermPeriodType" : "Month",  "currentTerm" : null,  "currentTermPeriodType" : "Month",  "autoRenew" : false,  "renewalSetting" : "RENEW_WITH_SPECIFIC_TERM",  "renewalTerm" : null,  "renewalTermPeriodType" : "Month",  "contractedMrr" : 15.00,  "totalContractedValue" : null,  "notes" : null,  "status" : "Expired",  "QuoteNumber__QT" : "Q006985",  "QuoteBusinessType__QT" : null,  "OpportunityCloseDate__QT" : null,  "OpportunityName__QT" : null,  "TECH_QuoteID__c" : "a133E000000G4Uj",  "CpqBundleJsonId__QT" : null,  "Type_de_geste__c" : "Création de souscription",  "QuoteType__QT" : "New Subscription",  "ratePlans" : [ {    "id" : "2c92c0fb5fbecca6015fc0268a295a70",    "lastChangeType" : "Add",    "productId" : "2c92c0f85432dece01543d00fc8b67f6",    "productName" : "Remise Offre CapRenov+",    "productSku" : "SKU-00000009",    "productRatePlanId" : "2c92c0f95f47f368015f4ef3117a571c",    "ratePlanName" : "Remise – Offre de parrainage - 1 mois d’abonnement(s) CapRenov+ offert(s)",    "ratePlanCharges" : [ {      "id" : "2c92c0fb5fbecca6015fc0268a295a71",      "originalChargeId" : "2c92c0fb5fbecca6015fc0268a295a71",      "productRatePlanChargeId" : "2c92c0f85f47da9c015f4ef78c6d378d",      "number" : "C-00004966",      "name" : "Remise – Offre de parrainage - 1 mois d’abonnement(s) CapRenov+ offert(s)",      "type" : "OneTime",      "model" : "FlatFee",      "uom" : null,      "version" : 1,      "pricingSummary" : "EUR-15",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : -15.000000000,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : null,      "listPriceBase" : null,      "billingPeriod" : null,      "specificBillingPeriod" : null,      "billingTiming" : null,      "billingPeriodAlignment" : null,      "quantity" : 1.000000000,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : null,      "segment" : 1,      "effectiveStartDate" : "2017-11-15",      "effectiveEndDate" : "2017-11-16",      "processedThroughDate" : "2017-11-15",      "chargedThroughDate" : "2017-11-16",      "done" : false,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "One_Time",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : null,      "dmrc" : null,      "tcv" : null,      "dtcv" : null,      "description" : "",      "License_number__c" : null,      "License_ID__c" : null    } ]  }, {    "id" : "2c92c0fb5fbecca6015fc0268a8b5a7b",    "lastChangeType" : "Remove",    "productId" : "2c92c0f95388d4a801539e9dcabd1fec",    "productName" : "Remise offre Homly Travaux",    "productSku" : "SKU-00000006",    "productRatePlanId" : "2c92c0f95f84c795015f96f911265c8e",    "ratePlanName" : "Remise - Abonnement Homly Travaux offert par Lapeyre",    "ratePlanCharges" : [ {      "id" : "2c92c0fb5fbecca6015fc0268a8b5a7c",      "originalChargeId" : "2c92c0f95fa60acc015fb60093ab5239",      "productRatePlanChargeId" : "2c92c0f85f84b717015f96fc97251e10",      "number" : "C-00004895",      "name" : "Remise - Abonnement Homly Travaux offert par Lapeyre",      "type" : "Recurring",      "model" : "FlatFee",      "uom" : null,      "version" : 2,      "pricingSummary" : "EUR-29",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : -29.000000000,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : "DefaultFromCustomer",      "listPriceBase" : "Per_Billing_Period",      "billingPeriod" : "Month",      "specificBillingPeriod" : null,      "billingTiming" : "IN_ADVANCE",      "billingPeriodAlignment" : "AlignToCharge",      "quantity" : 1.000000000,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : null,      "segment" : 1,      "effectiveStartDate" : "2017-11-13",      "effectiveEndDate" : "2017-11-14",      "processedThroughDate" : "2017-11-14",      "chargedThroughDate" : "2017-11-14",      "done" : true,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "Subscription_End",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : -29.000000000,      "dmrc" : 0E-9,      "tcv" : null,      "dtcv" : null,      "description" : "Remise - Abonnement Homly Travaux offert par Lapeyre",      "License_number__c" : null,      "License_ID__c" : null    } ]  }, {    "id" : "2c92c0fb5fbecca6015fc0268abe5a86",    "lastChangeType" : "Remove",    "productId" : "2c92c0f95388d4b50153984db70e2eda",    "productName" : "Offre Homly Travaux",    "productSku" : "SKU-00000004",    "productRatePlanId" : "2c92c0f954a999f20154bdeeadfa4962",    "ratePlanName" : "Offre Homly Travaux",    "ratePlanCharges" : [ {      "id" : "2c92c0fb5fbecca6015fc0268abe5a89",      "originalChargeId" : "2c92c0f95fa60acc015fb60093815233",      "productRatePlanChargeId" : "2c92c0f954a999f20154bdeeae5c4974",      "number" : "C-00004893",      "name" : "Opportunité de Chantier à 10€",      "type" : "Usage",      "model" : "PerUnit",      "uom" : "CAT_1",      "version" : 2,      "pricingSummary" : "EUR10/CAT_1",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : 10.000000000,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : "DefaultFromCustomer",      "listPriceBase" : null,      "billingPeriod" : "Month",      "specificBillingPeriod" : null,      "billingTiming" : null,      "billingPeriodAlignment" : "AlignToCharge",      "quantity" : null,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : "EndOfBillingPeriod",      "segment" : 1,      "effectiveStartDate" : "2017-11-13",      "effectiveEndDate" : "2017-11-14",      "processedThroughDate" : "2017-11-14",      "chargedThroughDate" : "2017-11-14",      "done" : true,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "Subscription_End",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : null,      "dmrc" : null,      "tcv" : null,      "dtcv" : null,      "description" : "Opportunité de Chantier à 10€",      "License_number__c" : null,      "License_ID__c" : null    }, {      "id" : "2c92c0fb5fbecca6015fc0268abe5a87",      "originalChargeId" : "2c92c0f95fa60acc015fb60093705231",      "productRatePlanChargeId" : "2c92c0f954a999f20154bdeeae0c4964",      "number" : "C-00004891",      "name" : "Opportunité de Chantier à 20€",      "type" : "Usage",      "model" : "PerUnit",      "uom" : "CAT_2",      "version" : 2,      "pricingSummary" : "EUR20/CAT_2",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : 20.000000000,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : "DefaultFromCustomer",      "listPriceBase" : null,      "billingPeriod" : "Month",      "specificBillingPeriod" : null,      "billingTiming" : null,      "billingPeriodAlignment" : "AlignToCharge",      "quantity" : null,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : "EndOfBillingPeriod",      "segment" : 1,      "effectiveStartDate" : "2017-11-13",      "effectiveEndDate" : "2017-11-14",      "processedThroughDate" : "2017-11-14",      "chargedThroughDate" : "2017-11-14",      "done" : true,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "Subscription_End",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : null,      "dmrc" : null,      "tcv" : null,      "dtcv" : null,      "description" : "Opportunité de Chantier à 20€",      "License_number__c" : null,      "License_ID__c" : null    }, {      "id" : "2c92c0fb5fbecca6015fc0268abe5a8a",      "originalChargeId" : "2c92c0f95fa60acc015fb60093895234",      "productRatePlanChargeId" : "2c92c0f954a999f20154bdeeae85497b",      "number" : "C-00004894",      "name" : "Opportunité de Chantier à 30€",      "type" : "Usage",      "model" : "PerUnit",      "uom" : "CAT_3",      "version" : 2,      "pricingSummary" : "EUR30/CAT_3",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : 30.000000000,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : "DefaultFromCustomer",      "listPriceBase" : null,      "billingPeriod" : "Month",      "specificBillingPeriod" : null,      "billingTiming" : null,      "billingPeriodAlignment" : "AlignToCharge",      "quantity" : null,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : "EndOfBillingPeriod",      "segment" : 1,      "effectiveStartDate" : "2017-11-13",      "effectiveEndDate" : "2017-11-14",      "processedThroughDate" : "2017-11-14",      "chargedThroughDate" : "2017-11-14",      "done" : true,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "Subscription_End",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : null,      "dmrc" : null,      "tcv" : null,      "dtcv" : null,      "description" : "Opportunité de Chantier à 30€",      "License_number__c" : null,      "License_ID__c" : null    }, {      "id" : "2c92c0fb5fbecca6015fc0268abe5a88",      "originalChargeId" : "2c92c0f95fa60acc015fb60093785232",      "productRatePlanChargeId" : "2c92c0f954a999f20154bdeeae34496b",      "number" : "C-00004892",      "name" : "Abonnement Offre Homly Travaux",      "type" : "Recurring",      "model" : "FlatFee",      "uom" : null,      "version" : 2,      "pricingSummary" : "EUR29",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : 29.000000000,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : "DefaultFromCustomer",      "listPriceBase" : "Per_Billing_Period",      "billingPeriod" : "Month",      "specificBillingPeriod" : null,      "billingTiming" : "IN_ADVANCE",      "billingPeriodAlignment" : "AlignToCharge",      "quantity" : 1.000000000,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : null,      "segment" : 1,      "effectiveStartDate" : "2017-11-13",      "effectiveEndDate" : "2017-11-14",      "processedThroughDate" : "2017-11-14",      "chargedThroughDate" : "2017-11-14",      "done" : true,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "Subscription_End",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : 29.000000000,      "dmrc" : 0E-9,      "tcv" : null,      "dtcv" : null,      "description" : "Abonnement Offre Travaux",      "License_number__c" : null,      "License_ID__c" : null    } ]  }, {    "id" : "2c92c0fb5fbecca6015fc0268ad35a8e",    "lastChangeType" : "Add",    "productId" : "2c92c0f85432dece01543d00fc8b67f6",    "productName" : "Remise Offre CapRenov+",    "productSku" : "SKU-00000009",    "productRatePlanId" : "2c92c0f85920055c015920f34b7d6df0",    "ratePlanName" : "Remise - avantage pack CapRenov+ ",    "ratePlanCharges" : [ {      "id" : "2c92c0fb5fbecca6015fc0268ad35a8f",      "originalChargeId" : "2c92c0f85fa5fca8015fb6496a507e9f",      "productRatePlanChargeId" : "2c92c0f9592011e6015922169b526e1f",      "number" : "C-00004906",      "name" : "Remise - avantage pack CapRenov+",      "type" : "Recurring",      "model" : "FlatFee",      "uom" : null,      "version" : 1,      "pricingSummary" : "EUR0",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : 0E-9,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : "DefaultFromCustomer",      "listPriceBase" : "Per_Billing_Period",      "billingPeriod" : "Month",      "specificBillingPeriod" : null,      "billingTiming" : "IN_ADVANCE",      "billingPeriodAlignment" : "AlignToCharge",      "quantity" : 1.000000000,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : null,      "segment" : 1,      "effectiveStartDate" : "2017-11-14",      "effectiveEndDate" : null,      "processedThroughDate" : "2017-11-14",      "chargedThroughDate" : "2017-12-13",      "done" : false,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "Subscription_End",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : 0E-9,      "dmrc" : 0E-9,      "tcv" : null,      "dtcv" : null,      "description" : "",      "License_number__c" : null,      "License_ID__c" : null    } ]  }, {    "id" : "2c92c0fb5fbecca6015fc0268ae75a93",    "lastChangeType" : "Add",    "productId" : "2c92c0f85388c41e015398133fc30753",    "productName" : "Offre CapRenov+",    "productSku" : "SKU-00000001",    "productRatePlanId" : "2c92c0f9547a457d01547b455fd14d18",    "ratePlanName" : "Abonnement CapRenov+",    "ratePlanCharges" : [ {      "id" : "2c92c0fb5fbecca6015fc0268ae85a94",      "originalChargeId" : "2c92c0f85fa5fca8015fb64969f27e97",      "productRatePlanChargeId" : "2c92c0f9547a457d01547b455fe84d1a",      "number" : "C-00004905",      "name" : "Abonnement CapRenov+",      "type" : "Recurring",      "model" : "PerUnit",      "uom" : "License",      "version" : 1,      "pricingSummary" : "EUR15/License",      "priceChangeOption" : null,      "priceIncreasePercentage" : null,      "currency" : "EUR",      "price" : 15.000000000,      "tiers" : null,      "includedUnits" : null,      "overagePrice" : null,      "discountPercentage" : null,      "discountAmount" : null,      "applyDiscountTo" : null,      "discountLevel" : null,      "discountClass" : null,      "discountApplyDetails" : [ ],      "billingDay" : "DefaultFromCustomer",      "listPriceBase" : "Per_Billing_Period",      "billingPeriod" : "Month",      "specificBillingPeriod" : null,      "billingTiming" : "IN_ADVANCE",      "billingPeriodAlignment" : "AlignToCharge",      "quantity" : 1.000000000,      "smoothingModel" : null,      "numberOfPeriods" : null,      "overageCalculationOption" : null,      "overageUnusedUnitsCreditOption" : null,      "unusedUnitsCreditRates" : null,      "usageRecordRatingOption" : null,      "segment" : 1,      "effectiveStartDate" : "2017-11-14",      "effectiveEndDate" : null,      "processedThroughDate" : "2017-11-14",      "chargedThroughDate" : "2017-12-13",      "done" : false,      "triggerDate" : null,      "triggerEvent" : "ServiceActivation",      "endDateCondition" : "Subscription_End",      "upToPeriodsType" : null,      "upToPeriods" : null,      "specificEndDate" : null,      "mrr" : 15.000000000,      "dmrc" : 15.000000000,      "tcv" : null,      "dtcv" : null,      "description" : "Abonnement CapRenov+",      "License_number__c" : null,      "License_ID__c" : null    } ]} ]}';
        return json;
    }
    }

    
}