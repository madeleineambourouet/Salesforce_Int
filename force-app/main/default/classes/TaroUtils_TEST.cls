/**
 * @File Name          : TaroUtils_TEST.cls
 * @Description        : 
 * @Author             : Hassan Dakhcha
 * @Group              : 
 * @Last Modified By   : Hassan Dakhcha
 * @Last Modified On   : 01-28-2021
 * @Modification Log   : 
 * Ver       Date            Author      		    Modification
 * 1.0    5/25/2020   Hassan Dakhcha     Initial Version
**/
@isTest
public class TaroUtils_TEST {

    static testmethod void getParametersFromJsonTest() {

        Test.startTest();
        String jsonString = '{"package_info":{"id":1431,"code":"PACK_FUNNEL_MAISON","name":"Funnel Maison","BSKU":"B1101"},"postalCode": {"postalCode": "95580","inseeCode": "95014","name": "ANDILLY"},"summary":{"sections":[{"code":"PIECES_MAISON","label":"Pièces à rénover","items":[{"code":"CUISINE","label":"Cuisine","value":"1"},{"code":"SDB","label":"Salle de bain","value":"1"},{"code":"WC","label":"WC","value":"1"},{"code":"BUANDERIE","label":"Buanderie","value":"0"},{"code":"CHAMBRE_BUREAU","label":"Chambre - Bureau","value":"0"},{"code":"SALON_SEJOUR","label":"Salon - Séjour","value":"1"},{"code":"ENTREE_COULOIR","label":"Entrée - Couloir","value":"0"},{"code":"COMBLES","label":"Combles","value":"1"},{"code":"SURFACE_TOTALE","label":"Surface totale","value":"37 m²"}]},{"code":"REVETEMENTS_A_POSER","label":"Revêtements à poser","categories":[{"code":"SOL","label":"Sol","items":[{"code":"PARQUET","label":"Parquet","value":"0 m²"},{"code":"STRATIFIE","label":"Sol stratifié","value":"0 m²"},{"code":"PVC","label":"PVC","value":"0 m²"},{"code":"RENOVATION_PARQUET","label":"Rénovation de parquet","value":"0 m²"},{"code":"CARRELAGE","label":"Carrelage","value":"0 m²"},{"code":"MOSAIQUE","label":"Mosaïque","value":"0 m²"},{"code":"MOQUETTE","label":"Moquette","value":"0 m²"}]}],"items":[{"code":"MUR_PEINTURE","label":"Peinture","value":"Oui"}]},{"code":"EQUIPEMENT_A_INSTALLER","label":"Équipement à installer","categories":[{"code":"SDB","label":"Salle de bain","items":[{"code":"BAIGNOIRE","label":"Baignoire","value":"1"},{"code":"DOUCHE","label":"Douche","value":"1"},{"code":"DOUCHE_ITALIENNE","label":"Douche à l’italienne","value":"0"},{"code":"SDB_MEUBLE","label":"Meuble Vasque","value":"0"},{"code":"SDB_LAVABO","label":"Douche à l’italienne","value":"0"},{"code":"SDB_SECHE_SERVIETTE","label":"Sèche serviette","value":"0"},{"code":"SDB_WC","label":"WC","value":"1"}]},{"code":"WC","label":"WC","items":[{"code":"WC_SOL","label":"WC posé au sol","value":"1"}]},{"code":"CUISINE","label":"Cuisine","items":[{"code":"MEUBLE_CUISINE","label":"Meuble cuisine et électroménager","value":"Non"},{"code":"FABRICATION_MONTAGE","label":"Fabrication et montage","value":"Non"}]},{"code":"CHAUFFAGE_VENTILATION","label":"Chauffage et ventilation","items":[{"code":"CHAUDIERE_GAZ","label":"Chaudière gaz","value":"Non"},{"code":"SYSTEME_VENTILATION","label":"Système de ventilation","value":"Non"}]}]},{"code":"MUR_CLOISON","label":"Mur intérieur et cloison","categories":[{"code":"MONTAGE_CLOISON","label":"Montage de cloison","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"VERRIERE","label":"Verrière","value":"0 m"},{"code":"VERRIERE_MURET","label":"Verrière sur muret","value":"0 m"}]},{"code":"DEMOLITION_MUR","label":"Démolition de mur","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"MUR_PORTEUR","label":"Mur porteur","value":"0 m"},{"code":"MUR_INDETERMINE","label":"Mur indéterminé","value":"0 m"}]}]},{"code":"MENUISERIE","label":"Menuiserie","categories":[{"code":"FENETRE","label":"Fenêtre","items":[{"code":"FENETRE_STANDARD","label":"Fenêtre","value":"0"},{"code":"FENETRE_TOIT","label":"Fenêtre de toit","value":"0"},{"code":"PORTE_FENETRE","label":"Porte fenêtre","value":"0"},{"code":"BAIE_VITREE","label":"Baie vitrée","value":"0"}]},{"code":"Porte","label":"Porte","items":[{"code":"PORTE_BATTANTE","label":"Porte battante","value":"0"},{"code":"PORTE_COULISSANTE","label":"Porte coulissante","value":"0"},{"code":"PORTE_ENTREE","label":"Porte d’entrée","value":"0"}]},{"code":"ESCALIER","label":"Escalier","items":[{"code":"ECALIER_DROIT","label":"Ecalier droit","value":"0"},{"code":"ESCALIER_MEUNIER","label":"Escalier de meunier","value":"0"},{"code":"ESCALIER_COLIMAÇON","label":"Escalier en colimaçon","value":"0"}]}]},{"code":"RAVALEMENT_FACADE","label":"Ravalement de façade","items":[{"code":"PEINTURE_EXTERIEURE","label":"Peinture extérieure","value":"0 m²"},{"code":"BARDAGE","label":"Bardage","value":"0 m²"},{"code":"ENDUIT_CREPI","label":"Enduit / Crépi","value":"0 m²"}]},{"code":"ISOLATION_THERMIQUE","label":"Isolation thermique","categories":[{"code":"ISOLATION_INTERIEURE","label":"Isolation intérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"},{"code":"COMBLES_AMENAGES","label":"Combles aménagés","value":"0 m²"},{"code":"COMBLES_PERDUS","label":"Combles perdus","value":"0 m²"}]},{"code":"ISOLATION_EXTERIEURE","label":"Isolation extérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"}]}]},{"code":"ELECTRICITE","label":"Electricité","items":[{"code":"ELECTRICITE_NORME","label":"Mise aux normes de l’électricité","value":"Non"}]}]},"tva":{"minimum":860,"maximum":1050},"total":{"minimum":9400,"maximum":11500},"parameters":{"nb_renover_cuisine":"1","s_cuisine":"10","nb_renover_sdb":"1","s_sdb":"01","nb_renover_wc":"1","s_wc":"20","nb_renover_buanderie":"0","s_buanderie":"0","nb_renover_chambre":"0","s_chbre":"0","nb_renover_salon":"1","s_salon":"5","nb_renover_entree":"0","s_couloir":"0","nb_renover_combles":"1","s_combles":"01","liste_travaux":[{"quantity":1,"categorie":"rvt","name":"NB_FUNNEL_MAISON_TRAVAUX_PEINTURE","label":"Peinture"},{"quantity":1,"categorie":"equip","name":"NB_FUNNEL_MAISON_TRAVAUX_SDB","label":"Salle de bain"}],"equipement_sdb":{"sdb_1":[{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_BAIGNOIRE","label":"Baignoire"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_DOUCHE","label":"Douche"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_WC","label":"Toilettes"}]},"equip_cuisine":"","rvt_cuisine":"","rvt_sdb":"","rvt_wc":"","rvt_buanderie":"","rvt_salon":"","rvt_chbre":"","rvt_entree":"","rvt_comble":"","longueur_a_creer_verriere":"0","longueur_a_creer_verriere_muret":"0","longueur_a_creer_cloison":"0","longueur_a_sup_mur":"0","longueur_a_sup_cloison":"0","longueur_a_sup_jnsp":"0","nb_funnel_maison_type_fenetre_fenetre":"0","nb_funnel_maison_type_fenetre_porte_fenetre":"0","nb_funnel_maison_type_fenetre_baie_vitree":"0","nb_funnel_maison_type_fenetre_fenetre_toit":"0","nb_funnel_maison_type_porte_battante":"0","nb_funnel_maison_type_porte_coulissante":"0","nb_funnel_maison_type_porte_entree":"0","nb_funnel_maison_type_escalier_droit":"0","nb_funnel_maison_type_escalier_colimacon":"0","nb_funnel_maison_type_escalier_echelle_meunier":"0","surface_bardage":"0","surface_enduit":"0","surface_peinture":"0","s_mur_iso_int":"0","s_mur_iso_ext":"0","type_iso_comble":"","nb_funnel_maison_equip_chauffage_chaudiere":"0","nb_funnel_maison_equip_chauffage_ballon_eau_chaude":"0","nb_funnel_maison_equip_chauffage_radiateur_eau":"0","nb_funnel_maison_equip_chauffage_radiateur_elec":"0","geographic_question":"75019"},"prestations":[{"id_prestation":"P0511","id":1413,"name":"PRESTA : Installation d\'une baignoire","code":"ELEM_PRESTA_INSTAL_BAIGNOIRE","total":{"minimum":1600,"maximum":1900}},{"id_prestation":"P0509","id":1411,"name":"PRESTA : Installation d\'une douche","code":"ELEM_PRESTA_INSTAL_DOUCHE","total":{"minimum":1700,"maximum":2100}},{"id_prestation":"P0508","id":1410,"name":"PRESTA : Installation d\'un WC","code":"ELEM_PRESTA_INSTAL_WC","total":{"minimum":1100,"maximum":1300}},{"id_prestation":"P0501","id":1407,"name":"PRESTA : Alimentation et évacuation des eaux","code":"ELEM_PRESTA_ALIMENTATION_EVACUATION_EAUX","total":{"minimum":810,"maximum":990}},{"id_prestation":"P0402","id":1405,"name":"PRESTA : Application d\'une peinture intérieure","code":"ELEM_PRESTA_APPLICATION_PEINTURE_INT","total":{"minimum":4210,"maximum":5220}}]}';

        String retour = TaroUtils.getParametersFromJson(jsonString);
        Map<String, Object> jsonMap = (Map<String, Object>)JSON.deserializeUntyped(retour);
        String nb_renover_cuisine = JSON.serialize(jsonMap.get('nb_renover_cuisine'));
        System.assertEquals(nb_renover_cuisine,'"1"');
        Test.stopTest();
    }
    static testmethod void getChiffrageFromJsonTest() {

        Test.startTest();
        String jsonString = '{"package_info":{"id":1431,"code":"PACK_FUNNEL_MAISON","name":"Funnel Maison","BSKU":"B1101"},"postalCode": {"postalCode": "95580","inseeCode": "95014","name": "ANDILLY"},"summary":{"sections":[{"code":"PIECES_MAISON","label":"Pièces à rénover","items":[{"code":"CUISINE","label":"Cuisine","value":"1"},{"code":"SDB","label":"Salle de bain","value":"1"},{"code":"WC","label":"WC","value":"1"},{"code":"BUANDERIE","label":"Buanderie","value":"0"},{"code":"CHAMBRE_BUREAU","label":"Chambre - Bureau","value":"0"},{"code":"SALON_SEJOUR","label":"Salon - Séjour","value":"1"},{"code":"ENTREE_COULOIR","label":"Entrée - Couloir","value":"0"},{"code":"COMBLES","label":"Combles","value":"1"},{"code":"SURFACE_TOTALE","label":"Surface totale","value":"37 m²"}]},{"code":"REVETEMENTS_A_POSER","label":"Revêtements à poser","categories":[{"code":"SOL","label":"Sol","items":[{"code":"PARQUET","label":"Parquet","value":"0 m²"},{"code":"STRATIFIE","label":"Sol stratifié","value":"0 m²"},{"code":"PVC","label":"PVC","value":"0 m²"},{"code":"RENOVATION_PARQUET","label":"Rénovation de parquet","value":"0 m²"},{"code":"CARRELAGE","label":"Carrelage","value":"0 m²"},{"code":"MOSAIQUE","label":"Mosaïque","value":"0 m²"},{"code":"MOQUETTE","label":"Moquette","value":"0 m²"}]}],"items":[{"code":"MUR_PEINTURE","label":"Peinture","value":"Oui"}]},{"code":"EQUIPEMENT_A_INSTALLER","label":"Équipement à installer","categories":[{"code":"SDB","label":"Salle de bain","items":[{"code":"BAIGNOIRE","label":"Baignoire","value":"1"},{"code":"DOUCHE","label":"Douche","value":"1"},{"code":"DOUCHE_ITALIENNE","label":"Douche à l’italienne","value":"0"},{"code":"SDB_MEUBLE","label":"Meuble Vasque","value":"0"},{"code":"SDB_LAVABO","label":"Douche à l’italienne","value":"0"},{"code":"SDB_SECHE_SERVIETTE","label":"Sèche serviette","value":"0"},{"code":"SDB_WC","label":"WC","value":"1"}]},{"code":"WC","label":"WC","items":[{"code":"WC_SOL","label":"WC posé au sol","value":"1"}]},{"code":"CUISINE","label":"Cuisine","items":[{"code":"MEUBLE_CUISINE","label":"Meuble cuisine et électroménager","value":"Non"},{"code":"FABRICATION_MONTAGE","label":"Fabrication et montage","value":"Non"}]},{"code":"CHAUFFAGE_VENTILATION","label":"Chauffage et ventilation","items":[{"code":"CHAUDIERE_GAZ","label":"Chaudière gaz","value":"Non"},{"code":"SYSTEME_VENTILATION","label":"Système de ventilation","value":"Non"}]}]},{"code":"MUR_CLOISON","label":"Mur intérieur et cloison","categories":[{"code":"MONTAGE_CLOISON","label":"Montage de cloison","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"VERRIERE","label":"Verrière","value":"0 m"},{"code":"VERRIERE_MURET","label":"Verrière sur muret","value":"0 m"}]},{"code":"DEMOLITION_MUR","label":"Démolition de mur","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"MUR_PORTEUR","label":"Mur porteur","value":"0 m"},{"code":"MUR_INDETERMINE","label":"Mur indéterminé","value":"0 m"}]}]},{"code":"MENUISERIE","label":"Menuiserie","categories":[{"code":"FENETRE","label":"Fenêtre","items":[{"code":"FENETRE_STANDARD","label":"Fenêtre","value":"0"},{"code":"FENETRE_TOIT","label":"Fenêtre de toit","value":"0"},{"code":"PORTE_FENETRE","label":"Porte fenêtre","value":"0"},{"code":"BAIE_VITREE","label":"Baie vitrée","value":"0"}]},{"code":"Porte","label":"Porte","items":[{"code":"PORTE_BATTANTE","label":"Porte battante","value":"0"},{"code":"PORTE_COULISSANTE","label":"Porte coulissante","value":"0"},{"code":"PORTE_ENTREE","label":"Porte d’entrée","value":"0"}]},{"code":"ESCALIER","label":"Escalier","items":[{"code":"ECALIER_DROIT","label":"Ecalier droit","value":"0"},{"code":"ESCALIER_MEUNIER","label":"Escalier de meunier","value":"0"},{"code":"ESCALIER_COLIMAÇON","label":"Escalier en colimaçon","value":"0"}]}]},{"code":"RAVALEMENT_FACADE","label":"Ravalement de façade","items":[{"code":"PEINTURE_EXTERIEURE","label":"Peinture extérieure","value":"0 m²"},{"code":"BARDAGE","label":"Bardage","value":"0 m²"},{"code":"ENDUIT_CREPI","label":"Enduit / Crépi","value":"0 m²"}]},{"code":"ISOLATION_THERMIQUE","label":"Isolation thermique","categories":[{"code":"ISOLATION_INTERIEURE","label":"Isolation intérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"},{"code":"COMBLES_AMENAGES","label":"Combles aménagés","value":"0 m²"},{"code":"COMBLES_PERDUS","label":"Combles perdus","value":"0 m²"}]},{"code":"ISOLATION_EXTERIEURE","label":"Isolation extérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"}]}]},{"code":"ELECTRICITE","label":"Electricité","items":[{"code":"ELECTRICITE_NORME","label":"Mise aux normes de l’électricité","value":"Non"}]}]},"tva":{"minimum":860,"maximum":1050},"total":{"minimum":9400,"maximum":11500},"parameters":{"nb_renover_cuisine":"1","s_cuisine":"10","nb_renover_sdb":"1","s_sdb":"01","nb_renover_wc":"1","s_wc":"20","nb_renover_buanderie":"0","s_buanderie":"0","nb_renover_chambre":"0","s_chbre":"0","nb_renover_salon":"1","s_salon":"5","nb_renover_entree":"0","s_couloir":"0","nb_renover_combles":"1","s_combles":"01","liste_travaux":[{"quantity":1,"categorie":"rvt","name":"NB_FUNNEL_MAISON_TRAVAUX_PEINTURE","label":"Peinture"},{"quantity":1,"categorie":"equip","name":"NB_FUNNEL_MAISON_TRAVAUX_SDB","label":"Salle de bain"}],"equipement_sdb":{"sdb_1":[{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_BAIGNOIRE","label":"Baignoire"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_DOUCHE","label":"Douche"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_WC","label":"Toilettes"}]},"equip_cuisine":"","rvt_cuisine":"","rvt_sdb":"","rvt_wc":"","rvt_buanderie":"","rvt_salon":"","rvt_chbre":"","rvt_entree":"","rvt_comble":"","longueur_a_creer_verriere":"0","longueur_a_creer_verriere_muret":"0","longueur_a_creer_cloison":"0","longueur_a_sup_mur":"0","longueur_a_sup_cloison":"0","longueur_a_sup_jnsp":"0","nb_funnel_maison_type_fenetre_fenetre":"0","nb_funnel_maison_type_fenetre_porte_fenetre":"0","nb_funnel_maison_type_fenetre_baie_vitree":"0","nb_funnel_maison_type_fenetre_fenetre_toit":"0","nb_funnel_maison_type_porte_battante":"0","nb_funnel_maison_type_porte_coulissante":"0","nb_funnel_maison_type_porte_entree":"0","nb_funnel_maison_type_escalier_droit":"0","nb_funnel_maison_type_escalier_colimacon":"0","nb_funnel_maison_type_escalier_echelle_meunier":"0","surface_bardage":"0","surface_enduit":"0","surface_peinture":"0","s_mur_iso_int":"0","s_mur_iso_ext":"0","type_iso_comble":"","nb_funnel_maison_equip_chauffage_chaudiere":"0","nb_funnel_maison_equip_chauffage_ballon_eau_chaude":"0","nb_funnel_maison_equip_chauffage_radiateur_eau":"0","nb_funnel_maison_equip_chauffage_radiateur_elec":"0","geographic_question":"75019"},"prestations":[{"id_prestation":"P0511","id":1413,"name":"PRESTA : Installation d\'une baignoire","code":"ELEM_PRESTA_INSTAL_BAIGNOIRE","total":{"minimum":1600,"maximum":1900}},{"id_prestation":"P0509","id":1411,"name":"PRESTA : Installation d\'une douche","code":"ELEM_PRESTA_INSTAL_DOUCHE","total":{"minimum":1700,"maximum":2100}},{"id_prestation":"P0508","id":1410,"name":"PRESTA : Installation d\'un WC","code":"ELEM_PRESTA_INSTAL_WC","total":{"minimum":1100,"maximum":1300}},{"id_prestation":"P0501","id":1407,"name":"PRESTA : Alimentation et évacuation des eaux","code":"ELEM_PRESTA_ALIMENTATION_EVACUATION_EAUX","total":{"minimum":810,"maximum":990}},{"id_prestation":"P0402","id":1405,"name":"PRESTA : Application d\'une peinture intérieure","code":"ELEM_PRESTA_APPLICATION_PEINTURE_INT","total":{"minimum":4210,"maximum":5220}}]}';

        TaroUtils.TaroChiffrage taroChiffrage = TaroUtils.getChiffrageFromJson(jsonString);
        System.assertEquals(taroChiffrage.package_info.BSKU,'B1101');
        Test.stopTest();
    }
    static testmethod void getDataProjetLMSGFromChiffrageTest() {

        Test.startTest();
	    List<Account> listAccounts = new List<Account>();
	    List<Reference__c> listReferences = new List<Reference__c>();
		Reference__c pays = TestFactory.createReference('pays', 'France','FRA','France');
		Reference__c CP = TestFactory.createReference('CP', '75017','75017','Paris');
        Reference__c CP2 = TestFactory.createReference('CP', '95580','95014','ANDILLY');

		listReferences.add(CP);
        listReferences.add(CP2);
		listReferences.add(pays);
		insert listReferences;

		Account particulier = TestFactory.createAccount(false, pays, CP, null, null);
		particulier.PersonEmail = 'testTarod@notation.fr';

		listAccounts.add(particulier);
		insert listAccounts;

        Projet_LMSG__c projetLmsg = new Projet_LMSG__c();
        projetLmsg.particulier__c = particulier.Id;
        projetLmsg.Chiffrage_bsku__c = 'BSKU';
        projetLmsg.Chiffrage_json__c = '';
        projetLmsg.Chiffrage_maximum__c = null;
        projetLmsg.Chiffrage_minimum__c= null;
        insert projetLmsg;

        String jsonString = '{"package_info":{"id":1431,"code":"PACK_FUNNEL_MAISON","name":"Funnel Maison","BSKU":"B1101"},"postalCode": {"postalCode": "95580","inseeCode": "95014","name": "ANDILLY"},"summary":{"sections":[{"code":"PIECES_MAISON","label":"Pièces à rénover","items":[{"code":"CUISINE","label":"Cuisine","value":"1"},{"code":"SDB","label":"Salle de bain","value":"1"},{"code":"WC","label":"WC","value":"1"},{"code":"BUANDERIE","label":"Buanderie","value":"0"},{"code":"CHAMBRE_BUREAU","label":"Chambre - Bureau","value":"0"},{"code":"SALON_SEJOUR","label":"Salon - Séjour","value":"1"},{"code":"ENTREE_COULOIR","label":"Entrée - Couloir","value":"0"},{"code":"COMBLES","label":"Combles","value":"1"},{"code":"SURFACE_TOTALE","label":"Surface totale","value":"37 m²"}]},{"code":"REVETEMENTS_A_POSER","label":"Revêtements à poser","categories":[{"code":"SOL","label":"Sol","items":[{"code":"PARQUET","label":"Parquet","value":"0 m²"},{"code":"STRATIFIE","label":"Sol stratifié","value":"0 m²"},{"code":"PVC","label":"PVC","value":"0 m²"},{"code":"RENOVATION_PARQUET","label":"Rénovation de parquet","value":"0 m²"},{"code":"CARRELAGE","label":"Carrelage","value":"0 m²"},{"code":"MOSAIQUE","label":"Mosaïque","value":"0 m²"},{"code":"MOQUETTE","label":"Moquette","value":"0 m²"}]}],"items":[{"code":"MUR_PEINTURE","label":"Peinture","value":"Oui"}]},{"code":"EQUIPEMENT_A_INSTALLER","label":"Équipement à installer","categories":[{"code":"SDB","label":"Salle de bain","items":[{"code":"BAIGNOIRE","label":"Baignoire","value":"1"},{"code":"DOUCHE","label":"Douche","value":"1"},{"code":"DOUCHE_ITALIENNE","label":"Douche à l’italienne","value":"0"},{"code":"SDB_MEUBLE","label":"Meuble Vasque","value":"0"},{"code":"SDB_LAVABO","label":"Douche à l’italienne","value":"0"},{"code":"SDB_SECHE_SERVIETTE","label":"Sèche serviette","value":"0"},{"code":"SDB_WC","label":"WC","value":"1"}]},{"code":"WC","label":"WC","items":[{"code":"WC_SOL","label":"WC posé au sol","value":"1"}]},{"code":"CUISINE","label":"Cuisine","items":[{"code":"MEUBLE_CUISINE","label":"Meuble cuisine et électroménager","value":"Non"},{"code":"FABRICATION_MONTAGE","label":"Fabrication et montage","value":"Non"}]},{"code":"CHAUFFAGE_VENTILATION","label":"Chauffage et ventilation","items":[{"code":"CHAUDIERE_GAZ","label":"Chaudière gaz","value":"Non"},{"code":"SYSTEME_VENTILATION","label":"Système de ventilation","value":"Non"}]}]},{"code":"MUR_CLOISON","label":"Mur intérieur et cloison","categories":[{"code":"MONTAGE_CLOISON","label":"Montage de cloison","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"VERRIERE","label":"Verrière","value":"0 m"},{"code":"VERRIERE_MURET","label":"Verrière sur muret","value":"0 m"}]},{"code":"DEMOLITION_MUR","label":"Démolition de mur","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"MUR_PORTEUR","label":"Mur porteur","value":"0 m"},{"code":"MUR_INDETERMINE","label":"Mur indéterminé","value":"0 m"}]}]},{"code":"MENUISERIE","label":"Menuiserie","categories":[{"code":"FENETRE","label":"Fenêtre","items":[{"code":"FENETRE_STANDARD","label":"Fenêtre","value":"0"},{"code":"FENETRE_TOIT","label":"Fenêtre de toit","value":"0"},{"code":"PORTE_FENETRE","label":"Porte fenêtre","value":"0"},{"code":"BAIE_VITREE","label":"Baie vitrée","value":"0"}]},{"code":"Porte","label":"Porte","items":[{"code":"PORTE_BATTANTE","label":"Porte battante","value":"0"},{"code":"PORTE_COULISSANTE","label":"Porte coulissante","value":"0"},{"code":"PORTE_ENTREE","label":"Porte d’entrée","value":"0"}]},{"code":"ESCALIER","label":"Escalier","items":[{"code":"ECALIER_DROIT","label":"Ecalier droit","value":"0"},{"code":"ESCALIER_MEUNIER","label":"Escalier de meunier","value":"0"},{"code":"ESCALIER_COLIMAÇON","label":"Escalier en colimaçon","value":"0"}]}]},{"code":"RAVALEMENT_FACADE","label":"Ravalement de façade","items":[{"code":"PEINTURE_EXTERIEURE","label":"Peinture extérieure","value":"0 m²"},{"code":"BARDAGE","label":"Bardage","value":"0 m²"},{"code":"ENDUIT_CREPI","label":"Enduit / Crépi","value":"0 m²"}]},{"code":"ISOLATION_THERMIQUE","label":"Isolation thermique","categories":[{"code":"ISOLATION_INTERIEURE","label":"Isolation intérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"},{"code":"COMBLES_AMENAGES","label":"Combles aménagés","value":"0 m²"},{"code":"COMBLES_PERDUS","label":"Combles perdus","value":"0 m²"}]},{"code":"ISOLATION_EXTERIEURE","label":"Isolation extérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"}]}]},{"code":"ELECTRICITE","label":"Electricité","items":[{"code":"ELECTRICITE_NORME","label":"Mise aux normes de l’électricité","value":"Non"}]}]},"tva":{"minimum":860,"maximum":1050},"total":{"minimum":9400,"maximum":11500},"parameters":{"nb_renover_cuisine":"1","s_cuisine":"10","nb_renover_sdb":"1","s_sdb":"01","nb_renover_wc":"1","s_wc":"20","nb_renover_buanderie":"0","s_buanderie":"0","nb_renover_chambre":"0","s_chbre":"0","nb_renover_salon":"1","s_salon":"5","nb_renover_entree":"0","s_couloir":"0","nb_renover_combles":"1","s_combles":"01","liste_travaux":[{"quantity":1,"categorie":"rvt","name":"NB_FUNNEL_MAISON_TRAVAUX_PEINTURE","label":"Peinture"},{"quantity":1,"categorie":"equip","name":"NB_FUNNEL_MAISON_TRAVAUX_SDB","label":"Salle de bain"}],"equipement_sdb":{"sdb_1":[{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_BAIGNOIRE","label":"Baignoire"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_DOUCHE","label":"Douche"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_WC","label":"Toilettes"}]},"equip_cuisine":"","rvt_cuisine":"","rvt_sdb":"","rvt_wc":"","rvt_buanderie":"","rvt_salon":"","rvt_chbre":"","rvt_entree":"","rvt_comble":"","longueur_a_creer_verriere":"0","longueur_a_creer_verriere_muret":"0","longueur_a_creer_cloison":"0","longueur_a_sup_mur":"0","longueur_a_sup_cloison":"0","longueur_a_sup_jnsp":"0","nb_funnel_maison_type_fenetre_fenetre":"0","nb_funnel_maison_type_fenetre_porte_fenetre":"0","nb_funnel_maison_type_fenetre_baie_vitree":"0","nb_funnel_maison_type_fenetre_fenetre_toit":"0","nb_funnel_maison_type_porte_battante":"0","nb_funnel_maison_type_porte_coulissante":"0","nb_funnel_maison_type_porte_entree":"0","nb_funnel_maison_type_escalier_droit":"0","nb_funnel_maison_type_escalier_colimacon":"0","nb_funnel_maison_type_escalier_echelle_meunier":"0","surface_bardage":"0","surface_enduit":"0","surface_peinture":"0","s_mur_iso_int":"0","s_mur_iso_ext":"0","type_iso_comble":"","nb_funnel_maison_equip_chauffage_chaudiere":"0","nb_funnel_maison_equip_chauffage_ballon_eau_chaude":"0","nb_funnel_maison_equip_chauffage_radiateur_eau":"0","nb_funnel_maison_equip_chauffage_radiateur_elec":"0","geographic_question":"75019"},"prestations":[{"id_prestation":"P0511","id":1413,"name":"PRESTA : Installation d\'une baignoire","code":"ELEM_PRESTA_INSTAL_BAIGNOIRE","total":{"minimum":1600,"maximum":1900}},{"id_prestation":"P0509","id":1411,"name":"PRESTA : Installation d\'une douche","code":"ELEM_PRESTA_INSTAL_DOUCHE","total":{"minimum":1700,"maximum":2100}},{"id_prestation":"P0508","id":1410,"name":"PRESTA : Installation d\'un WC","code":"ELEM_PRESTA_INSTAL_WC","total":{"minimum":1100,"maximum":1300}},{"id_prestation":"P0501","id":1407,"name":"PRESTA : Alimentation et évacuation des eaux","code":"ELEM_PRESTA_ALIMENTATION_EVACUATION_EAUX","total":{"minimum":810,"maximum":990}},{"id_prestation":"P0402","id":1405,"name":"PRESTA : Application d\'une peinture intérieure","code":"ELEM_PRESTA_APPLICATION_PEINTURE_INT","total":{"minimum":4210,"maximum":5220}}]}';

        projetLmsg.Chiffrage_json__c = jsonString;
        update projetLmsg;
        
        projetLmsg=[SELECT id, Chiffrage_maximum__c FROM Projet_LMSG__c WHERE id=:projetLmsg.id];
        System.assertEquals(projetLmsg.Chiffrage_maximum__c,11500);
        Test.stopTest();
    }
    static testmethod void getDataNewProjetLMSGFromChiffrageTest() {

        ID RTCodePostal = [SELECT Id FROM RecordType WHERE DeveloperName = 'CP_Ville' LIMIT 1].Id;
        Test.startTest();
	    List<Account> listAccounts = new List<Account>();
	    List<Reference__c> listReferences = new List<Reference__c>();
		Reference__c pays = TestFactory.createReference('pays', 'France','FRA','France');
        Reference__c CP = TestFactory.createReference('CP', '75017','75017','Paris');
        Reference__c CP2 = TestFactory.createReference('CP', '95580','95014','ANDILLY');
        CP.RecordTypeId = RTCodePostal;
        CP2.RecordTypeId = RTCodePostal;

        listReferences.add(CP);
        listReferences.add(CP2);
		listReferences.add(pays);
		insert listReferences;

		Account particulier = TestFactory.createAccount(false, pays, CP, null, null);
		particulier.PersonEmail = 'testTarod@notation.fr';

		listAccounts.add(particulier);
		insert listAccounts;

        String jsonString = '{"package_info":{"id":1431,"code":"PACK_FUNNEL_MAISON","name":"Funnel Maison","BSKU":"B1101"},"postalCode": {"postalCode": "95580","inseeCode": "95014","name": "ANDILLY"},"summary":{"sections":[{"code":"PIECES_MAISON","label":"Pièces à rénover","items":[{"code":"CUISINE","label":"Cuisine","value":"1"},{"code":"SDB","label":"Salle de bain","value":"1"},{"code":"WC","label":"WC","value":"1"},{"code":"BUANDERIE","label":"Buanderie","value":"0"},{"code":"CHAMBRE_BUREAU","label":"Chambre - Bureau","value":"0"},{"code":"SALON_SEJOUR","label":"Salon - Séjour","value":"1"},{"code":"ENTREE_COULOIR","label":"Entrée - Couloir","value":"0"},{"code":"COMBLES","label":"Combles","value":"1"},{"code":"SURFACE_TOTALE","label":"Surface totale","value":"37 m²"}]},{"code":"REVETEMENTS_A_POSER","label":"Revêtements à poser","categories":[{"code":"SOL","label":"Sol","items":[{"code":"PARQUET","label":"Parquet","value":"0 m²"},{"code":"STRATIFIE","label":"Sol stratifié","value":"0 m²"},{"code":"PVC","label":"PVC","value":"0 m²"},{"code":"RENOVATION_PARQUET","label":"Rénovation de parquet","value":"0 m²"},{"code":"CARRELAGE","label":"Carrelage","value":"0 m²"},{"code":"MOSAIQUE","label":"Mosaïque","value":"0 m²"},{"code":"MOQUETTE","label":"Moquette","value":"0 m²"}]}],"items":[{"code":"MUR_PEINTURE","label":"Peinture","value":"Oui"}]},{"code":"EQUIPEMENT_A_INSTALLER","label":"Équipement à installer","categories":[{"code":"SDB","label":"Salle de bain","items":[{"code":"BAIGNOIRE","label":"Baignoire","value":"1"},{"code":"DOUCHE","label":"Douche","value":"1"},{"code":"DOUCHE_ITALIENNE","label":"Douche à l’italienne","value":"0"},{"code":"SDB_MEUBLE","label":"Meuble Vasque","value":"0"},{"code":"SDB_LAVABO","label":"Douche à l’italienne","value":"0"},{"code":"SDB_SECHE_SERVIETTE","label":"Sèche serviette","value":"0"},{"code":"SDB_WC","label":"WC","value":"1"}]},{"code":"WC","label":"WC","items":[{"code":"WC_SOL","label":"WC posé au sol","value":"1"}]},{"code":"CUISINE","label":"Cuisine","items":[{"code":"MEUBLE_CUISINE","label":"Meuble cuisine et électroménager","value":"Non"},{"code":"FABRICATION_MONTAGE","label":"Fabrication et montage","value":"Non"}]},{"code":"CHAUFFAGE_VENTILATION","label":"Chauffage et ventilation","items":[{"code":"CHAUDIERE_GAZ","label":"Chaudière gaz","value":"Non"},{"code":"SYSTEME_VENTILATION","label":"Système de ventilation","value":"Non"}]}]},{"code":"MUR_CLOISON","label":"Mur intérieur et cloison","categories":[{"code":"MONTAGE_CLOISON","label":"Montage de cloison","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"VERRIERE","label":"Verrière","value":"0 m"},{"code":"VERRIERE_MURET","label":"Verrière sur muret","value":"0 m"}]},{"code":"DEMOLITION_MUR","label":"Démolition de mur","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"MUR_PORTEUR","label":"Mur porteur","value":"0 m"},{"code":"MUR_INDETERMINE","label":"Mur indéterminé","value":"0 m"}]}]},{"code":"MENUISERIE","label":"Menuiserie","categories":[{"code":"FENETRE","label":"Fenêtre","items":[{"code":"FENETRE_STANDARD","label":"Fenêtre","value":"0"},{"code":"FENETRE_TOIT","label":"Fenêtre de toit","value":"0"},{"code":"PORTE_FENETRE","label":"Porte fenêtre","value":"0"},{"code":"BAIE_VITREE","label":"Baie vitrée","value":"0"}]},{"code":"Porte","label":"Porte","items":[{"code":"PORTE_BATTANTE","label":"Porte battante","value":"0"},{"code":"PORTE_COULISSANTE","label":"Porte coulissante","value":"0"},{"code":"PORTE_ENTREE","label":"Porte d’entrée","value":"0"}]},{"code":"ESCALIER","label":"Escalier","items":[{"code":"ECALIER_DROIT","label":"Ecalier droit","value":"0"},{"code":"ESCALIER_MEUNIER","label":"Escalier de meunier","value":"0"},{"code":"ESCALIER_COLIMAÇON","label":"Escalier en colimaçon","value":"0"}]}]},{"code":"RAVALEMENT_FACADE","label":"Ravalement de façade","items":[{"code":"PEINTURE_EXTERIEURE","label":"Peinture extérieure","value":"0 m²"},{"code":"BARDAGE","label":"Bardage","value":"0 m²"},{"code":"ENDUIT_CREPI","label":"Enduit / Crépi","value":"0 m²"}]},{"code":"ISOLATION_THERMIQUE","label":"Isolation thermique","categories":[{"code":"ISOLATION_INTERIEURE","label":"Isolation intérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"},{"code":"COMBLES_AMENAGES","label":"Combles aménagés","value":"0 m²"},{"code":"COMBLES_PERDUS","label":"Combles perdus","value":"0 m²"}]},{"code":"ISOLATION_EXTERIEURE","label":"Isolation extérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"}]}]},{"code":"ELECTRICITE","label":"Electricité","items":[{"code":"ELECTRICITE_NORME","label":"Mise aux normes de l’électricité","value":"Non"}]}]},"tva":{"minimum":860,"maximum":1050},"total":{"minimum":9400,"maximum":11500},"parameters":{"nb_renover_cuisine":"1","s_cuisine":"10","nb_renover_sdb":"1","s_sdb":"01","nb_renover_wc":"1","s_wc":"20","nb_renover_buanderie":"0","s_buanderie":"0","nb_renover_chambre":"0","s_chbre":"0","nb_renover_salon":"1","s_salon":"5","nb_renover_entree":"0","s_couloir":"0","nb_renover_combles":"1","s_combles":"01","liste_travaux":[{"quantity":1,"categorie":"rvt","name":"NB_FUNNEL_MAISON_TRAVAUX_PEINTURE","label":"Peinture"},{"quantity":1,"categorie":"equip","name":"NB_FUNNEL_MAISON_TRAVAUX_SDB","label":"Salle de bain"}],"equipement_sdb":{"sdb_1":[{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_BAIGNOIRE","label":"Baignoire"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_DOUCHE","label":"Douche"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_WC","label":"Toilettes"}]},"equip_cuisine":"","rvt_cuisine":"","rvt_sdb":"","rvt_wc":"","rvt_buanderie":"","rvt_salon":"","rvt_chbre":"","rvt_entree":"","rvt_comble":"","longueur_a_creer_verriere":"0","longueur_a_creer_verriere_muret":"0","longueur_a_creer_cloison":"0","longueur_a_sup_mur":"0","longueur_a_sup_cloison":"0","longueur_a_sup_jnsp":"0","nb_funnel_maison_type_fenetre_fenetre":"0","nb_funnel_maison_type_fenetre_porte_fenetre":"0","nb_funnel_maison_type_fenetre_baie_vitree":"0","nb_funnel_maison_type_fenetre_fenetre_toit":"0","nb_funnel_maison_type_porte_battante":"0","nb_funnel_maison_type_porte_coulissante":"0","nb_funnel_maison_type_porte_entree":"0","nb_funnel_maison_type_escalier_droit":"0","nb_funnel_maison_type_escalier_colimacon":"0","nb_funnel_maison_type_escalier_echelle_meunier":"0","surface_bardage":"0","surface_enduit":"0","surface_peinture":"0","s_mur_iso_int":"0","s_mur_iso_ext":"0","type_iso_comble":"","nb_funnel_maison_equip_chauffage_chaudiere":"0","nb_funnel_maison_equip_chauffage_ballon_eau_chaude":"0","nb_funnel_maison_equip_chauffage_radiateur_eau":"0","nb_funnel_maison_equip_chauffage_radiateur_elec":"0","geographic_question":"75019"},"prestations":[{"id_prestation":"P0511","id":1413,"name":"PRESTA : Installation d\'une baignoire","code":"ELEM_PRESTA_INSTAL_BAIGNOIRE","total":{"minimum":1600,"maximum":1900}},{"id_prestation":"P0509","id":1411,"name":"PRESTA : Installation d\'une douche","code":"ELEM_PRESTA_INSTAL_DOUCHE","total":{"minimum":1700,"maximum":2100}},{"id_prestation":"P0508","id":1410,"name":"PRESTA : Installation d\'un WC","code":"ELEM_PRESTA_INSTAL_WC","total":{"minimum":1100,"maximum":1300}},{"id_prestation":"P0501","id":1407,"name":"PRESTA : Alimentation et évacuation des eaux","code":"ELEM_PRESTA_ALIMENTATION_EVACUATION_EAUX","total":{"minimum":810,"maximum":990}},{"id_prestation":"P0402","id":1405,"name":"PRESTA : Application d\'une peinture intérieure","code":"ELEM_PRESTA_APPLICATION_PEINTURE_INT","total":{"minimum":4210,"maximum":5220}}]}';

        TaroUtils.TaroChiffrage taroChiffrage = TaroUtils.getChiffrageFromJson(jsonString);
        Projet_LMSG__c projetLmsgData = TaroUtils.getDataNewProjetLMSGFromChiffrage(taroChiffrage, jsonString,  particulier.Id);
        insert projetLmsgData;
        projetLmsgData=[SELECT id, Chiffrage_minimum__c FROM Projet_LMSG__c WHERE id=:projetLmsgData.id];
        System.assertEquals(projetLmsgData.Chiffrage_minimum__c,9400);
        Test.stopTest();
    }
    static testmethod void getPrestationsFromChiffrageTest() {

        Test.startTest();
	    List<Account> listAccounts = new List<Account>();
	    List<Reference__c> listReferences = new List<Reference__c>();
		Reference__c pays = TestFactory.createReference('pays', 'France','FRA','France');
		Reference__c CP = TestFactory.createReference('CP', '75017','75017','Paris');
		Reference__c prestation = TestFactory.createReference('Prestation', 'Prestation1','P1','Prestation1');
		prestation.SKU__c = 'P0402';

		listReferences.add(CP);
		listReferences.add(pays);
		listReferences.add(prestation);
		insert listReferences;

		Account particulier = TestFactory.createAccount(false, pays, CP, null, null);
		particulier.PersonEmail = 'testTarod@notation.fr';

		listAccounts.add(particulier);
		insert listAccounts;

        Projet_LMSG__c projetLmsg = new Projet_LMSG__c();
        projetLmsg.particulier__c = particulier.Id;
        projetLmsg.Chiffrage_bsku__c = 'BSKU';
        projetLmsg.Chiffrage_json__c = '';
        projetLmsg.Chiffrage_maximum__c = null;
        projetLmsg.Chiffrage_minimum__c= null;
        insert projetLmsg;

        String jsonString = '{"package_info":{"id":1431,"code":"PACK_FUNNEL_MAISON","name":"Funnel Maison","BSKU":"B1101"},"postalCode": {"postalCode": "95580","inseeCode": "95014","name": "ANDILLY"},"summary":{"sections":[{"code":"PIECES_MAISON","label":"Pièces à rénover","items":[{"code":"CUISINE","label":"Cuisine","value":"1"},{"code":"SDB","label":"Salle de bain","value":"1"},{"code":"WC","label":"WC","value":"1"},{"code":"BUANDERIE","label":"Buanderie","value":"0"},{"code":"CHAMBRE_BUREAU","label":"Chambre - Bureau","value":"0"},{"code":"SALON_SEJOUR","label":"Salon - Séjour","value":"1"},{"code":"ENTREE_COULOIR","label":"Entrée - Couloir","value":"0"},{"code":"COMBLES","label":"Combles","value":"1"},{"code":"SURFACE_TOTALE","label":"Surface totale","value":"37 m²"}]},{"code":"REVETEMENTS_A_POSER","label":"Revêtements à poser","categories":[{"code":"SOL","label":"Sol","items":[{"code":"PARQUET","label":"Parquet","value":"0 m²"},{"code":"STRATIFIE","label":"Sol stratifié","value":"0 m²"},{"code":"PVC","label":"PVC","value":"0 m²"},{"code":"RENOVATION_PARQUET","label":"Rénovation de parquet","value":"0 m²"},{"code":"CARRELAGE","label":"Carrelage","value":"0 m²"},{"code":"MOSAIQUE","label":"Mosaïque","value":"0 m²"},{"code":"MOQUETTE","label":"Moquette","value":"0 m²"}]}],"items":[{"code":"MUR_PEINTURE","label":"Peinture","value":"Oui"}]},{"code":"EQUIPEMENT_A_INSTALLER","label":"Équipement à installer","categories":[{"code":"SDB","label":"Salle de bain","items":[{"code":"BAIGNOIRE","label":"Baignoire","value":"1"},{"code":"DOUCHE","label":"Douche","value":"1"},{"code":"DOUCHE_ITALIENNE","label":"Douche à l’italienne","value":"0"},{"code":"SDB_MEUBLE","label":"Meuble Vasque","value":"0"},{"code":"SDB_LAVABO","label":"Douche à l’italienne","value":"0"},{"code":"SDB_SECHE_SERVIETTE","label":"Sèche serviette","value":"0"},{"code":"SDB_WC","label":"WC","value":"1"}]},{"code":"WC","label":"WC","items":[{"code":"WC_SOL","label":"WC posé au sol","value":"1"}]},{"code":"CUISINE","label":"Cuisine","items":[{"code":"MEUBLE_CUISINE","label":"Meuble cuisine et électroménager","value":"Non"},{"code":"FABRICATION_MONTAGE","label":"Fabrication et montage","value":"Non"}]},{"code":"CHAUFFAGE_VENTILATION","label":"Chauffage et ventilation","items":[{"code":"CHAUDIERE_GAZ","label":"Chaudière gaz","value":"Non"},{"code":"SYSTEME_VENTILATION","label":"Système de ventilation","value":"Non"}]}]},{"code":"MUR_CLOISON","label":"Mur intérieur et cloison","categories":[{"code":"MONTAGE_CLOISON","label":"Montage de cloison","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"VERRIERE","label":"Verrière","value":"0 m"},{"code":"VERRIERE_MURET","label":"Verrière sur muret","value":"0 m"}]},{"code":"DEMOLITION_MUR","label":"Démolition de mur","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"MUR_PORTEUR","label":"Mur porteur","value":"0 m"},{"code":"MUR_INDETERMINE","label":"Mur indéterminé","value":"0 m"}]}]},{"code":"MENUISERIE","label":"Menuiserie","categories":[{"code":"FENETRE","label":"Fenêtre","items":[{"code":"FENETRE_STANDARD","label":"Fenêtre","value":"0"},{"code":"FENETRE_TOIT","label":"Fenêtre de toit","value":"0"},{"code":"PORTE_FENETRE","label":"Porte fenêtre","value":"0"},{"code":"BAIE_VITREE","label":"Baie vitrée","value":"0"}]},{"code":"Porte","label":"Porte","items":[{"code":"PORTE_BATTANTE","label":"Porte battante","value":"0"},{"code":"PORTE_COULISSANTE","label":"Porte coulissante","value":"0"},{"code":"PORTE_ENTREE","label":"Porte d’entrée","value":"0"}]},{"code":"ESCALIER","label":"Escalier","items":[{"code":"ECALIER_DROIT","label":"Ecalier droit","value":"0"},{"code":"ESCALIER_MEUNIER","label":"Escalier de meunier","value":"0"},{"code":"ESCALIER_COLIMAÇON","label":"Escalier en colimaçon","value":"0"}]}]},{"code":"RAVALEMENT_FACADE","label":"Ravalement de façade","items":[{"code":"PEINTURE_EXTERIEURE","label":"Peinture extérieure","value":"0 m²"},{"code":"BARDAGE","label":"Bardage","value":"0 m²"},{"code":"ENDUIT_CREPI","label":"Enduit / Crépi","value":"0 m²"}]},{"code":"ISOLATION_THERMIQUE","label":"Isolation thermique","categories":[{"code":"ISOLATION_INTERIEURE","label":"Isolation intérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"},{"code":"COMBLES_AMENAGES","label":"Combles aménagés","value":"0 m²"},{"code":"COMBLES_PERDUS","label":"Combles perdus","value":"0 m²"}]},{"code":"ISOLATION_EXTERIEURE","label":"Isolation extérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"}]}]},{"code":"ELECTRICITE","label":"Electricité","items":[{"code":"ELECTRICITE_NORME","label":"Mise aux normes de l’électricité","value":"Non"}]}]},"tva":{"minimum":860,"maximum":1050},"total":{"minimum":9400,"maximum":11500},"parameters":{"nb_renover_cuisine":"1","s_cuisine":"10","nb_renover_sdb":"1","s_sdb":"01","nb_renover_wc":"1","s_wc":"20","nb_renover_buanderie":"0","s_buanderie":"0","nb_renover_chambre":"0","s_chbre":"0","nb_renover_salon":"1","s_salon":"5","nb_renover_entree":"0","s_couloir":"0","nb_renover_combles":"1","s_combles":"01","liste_travaux":[{"quantity":1,"categorie":"rvt","name":"NB_FUNNEL_MAISON_TRAVAUX_PEINTURE","label":"Peinture"},{"quantity":1,"categorie":"equip","name":"NB_FUNNEL_MAISON_TRAVAUX_SDB","label":"Salle de bain"}],"equipement_sdb":{"sdb_1":[{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_BAIGNOIRE","label":"Baignoire"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_DOUCHE","label":"Douche"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_WC","label":"Toilettes"}]},"equip_cuisine":"","rvt_cuisine":"","rvt_sdb":"","rvt_wc":"","rvt_buanderie":"","rvt_salon":"","rvt_chbre":"","rvt_entree":"","rvt_comble":"","longueur_a_creer_verriere":"0","longueur_a_creer_verriere_muret":"0","longueur_a_creer_cloison":"0","longueur_a_sup_mur":"0","longueur_a_sup_cloison":"0","longueur_a_sup_jnsp":"0","nb_funnel_maison_type_fenetre_fenetre":"0","nb_funnel_maison_type_fenetre_porte_fenetre":"0","nb_funnel_maison_type_fenetre_baie_vitree":"0","nb_funnel_maison_type_fenetre_fenetre_toit":"0","nb_funnel_maison_type_porte_battante":"0","nb_funnel_maison_type_porte_coulissante":"0","nb_funnel_maison_type_porte_entree":"0","nb_funnel_maison_type_escalier_droit":"0","nb_funnel_maison_type_escalier_colimacon":"0","nb_funnel_maison_type_escalier_echelle_meunier":"0","surface_bardage":"0","surface_enduit":"0","surface_peinture":"0","s_mur_iso_int":"0","s_mur_iso_ext":"0","type_iso_comble":"","nb_funnel_maison_equip_chauffage_chaudiere":"0","nb_funnel_maison_equip_chauffage_ballon_eau_chaude":"0","nb_funnel_maison_equip_chauffage_radiateur_eau":"0","nb_funnel_maison_equip_chauffage_radiateur_elec":"0","geographic_question":"75019"},"prestations":[{"id_prestation":"P0511","id":1413,"name":"PRESTA : Installation d\'une baignoire","code":"ELEM_PRESTA_INSTAL_BAIGNOIRE","total":{"minimum":1600,"maximum":1900}},{"id_prestation":"P0509","id":1411,"name":"PRESTA : Installation d\'une douche","code":"ELEM_PRESTA_INSTAL_DOUCHE","total":{"minimum":1700,"maximum":2100}},{"id_prestation":"P0508","id":1410,"name":"PRESTA : Installation d\'un WC","code":"ELEM_PRESTA_INSTAL_WC","total":{"minimum":1100,"maximum":1300}},{"id_prestation":"P0501","id":1407,"name":"PRESTA : Alimentation et évacuation des eaux","code":"ELEM_PRESTA_ALIMENTATION_EVACUATION_EAUX","total":{"minimum":810,"maximum":990}},{"id_prestation":"P0402","id":1405,"name":"PRESTA : Application d\'une peinture intérieure","code":"ELEM_PRESTA_APPLICATION_PEINTURE_INT","total":{"minimum":4210,"maximum":5220}}]}';

        TaroUtils.TaroChiffrage taroChiffrage = TaroUtils.getChiffrageFromJson(jsonString);
        List<Prestation_Projet__c> prestationsProjet = TaroUtils.getPrestationsFromChiffrage(taroChiffrage,  projetLmsg.Id);
        System.assertEquals(prestationsProjet.size(),1);
        Test.stopTest();
    }
    static testmethod void getPrestationsFromProjetLMSGTest() {

        Test.startTest();
	    List<Account> listAccounts = new List<Account>();
	    List<Reference__c> listReferences = new List<Reference__c>();
	    List<Prestation_Projet__c> prestationsProjet = new List<Prestation_Projet__c>();
		Reference__c pays = TestFactory.createReference('pays', 'France','FRA','France');
		Reference__c CP = TestFactory.createReference('CP', '75017','75017','Paris');
		Reference__c prestation = TestFactory.createReference('Prestation', 'Prestation1','P1','Prestation1');

		listReferences.add(CP);
		listReferences.add(pays);
		listReferences.add(prestation);
		insert listReferences;

		Account particulier = TestFactory.createAccount(false, pays, CP, null, null);
		particulier.PersonEmail = 'testTarod@notation.fr';

		listAccounts.add(particulier);
		insert listAccounts;

        Projet_LMSG__c projetLmsg = new Projet_LMSG__c();
        projetLmsg.particulier__c = particulier.Id;
        projetLmsg.Chiffrage_bsku__c = 'BSKU';
        projetLmsg.Chiffrage_json__c = '';
        projetLmsg.Chiffrage_maximum__c = null;
        projetLmsg.Chiffrage_minimum__c= null;
        insert projetLmsg;

        Prestation_Projet__c prestationProjet = new Prestation_Projet__c();
		prestationProjet.Name = 'prestation1';
		prestationProjet.Projet_LMSG__c = projetLmsg.Id;
		prestationProjet.Minimum__c = 100;
		prestationProjet.Maximum__c = 400;
		prestationProjet.Prestation__c = prestation.Id;
		prestation.SKU__c = 'P0501';
		prestationsProjet.add(prestationProjet);
		insert prestationsProjet;

        List<Prestation_Projet__c> prestationsProjet2 = TaroUtils.getPrestationsFromProjetLMSG(projetLmsg.Id);
        System.assertEquals(prestationsProjet2.size(),1);
        Test.stopTest();
    }
    static testmethod void callChiffrageDetailTest() {

        Test.startTest();
        List<Account> listAccounts = new List<Account>();
        List<Reference__c> listReferences = new List<Reference__c>();
        Reference__c pays = TestFactory.createReference('pays', 'France','FRA','France');
        Reference__c CP = TestFactory.createReference('CP', '75017','75017','Paris');

        listReferences.add(CP);
        listReferences.add(pays);
        insert listReferences;

        Account particulier = TestFactory.createAccount(false, pays, CP, null, null);
        particulier.PersonEmail = 'testTarod@notation.fr';

        listAccounts.add(particulier);
        insert listAccounts;

        String jsonString = '{"package_info":{"id":1431,"code":"PACK_FUNNEL_MAISON","name":"Funnel Maison","BSKU":"B1101"},"postalCode": {"postalCode": "95580","inseeCode": "95014","name": "ANDILLY"},"summary":{"sections":[{"code":"PIECES_MAISON","label":"Pièces à rénover","items":[{"code":"CUISINE","label":"Cuisine","value":"1"},{"code":"SDB","label":"Salle de bain","value":"1"},{"code":"WC","label":"WC","value":"1"},{"code":"BUANDERIE","label":"Buanderie","value":"0"},{"code":"CHAMBRE_BUREAU","label":"Chambre - Bureau","value":"0"},{"code":"SALON_SEJOUR","label":"Salon - Séjour","value":"1"},{"code":"ENTREE_COULOIR","label":"Entrée - Couloir","value":"0"},{"code":"COMBLES","label":"Combles","value":"1"},{"code":"SURFACE_TOTALE","label":"Surface totale","value":"37 m²"}]},{"code":"REVETEMENTS_A_POSER","label":"Revêtements à poser","categories":[{"code":"SOL","label":"Sol","items":[{"code":"PARQUET","label":"Parquet","value":"0 m²"},{"code":"STRATIFIE","label":"Sol stratifié","value":"0 m²"},{"code":"PVC","label":"PVC","value":"0 m²"},{"code":"RENOVATION_PARQUET","label":"Rénovation de parquet","value":"0 m²"},{"code":"CARRELAGE","label":"Carrelage","value":"0 m²"},{"code":"MOSAIQUE","label":"Mosaïque","value":"0 m²"},{"code":"MOQUETTE","label":"Moquette","value":"0 m²"}]}],"items":[{"code":"MUR_PEINTURE","label":"Peinture","value":"Oui"}]},{"code":"EQUIPEMENT_A_INSTALLER","label":"Équipement à installer","categories":[{"code":"SDB","label":"Salle de bain","items":[{"code":"BAIGNOIRE","label":"Baignoire","value":"1"},{"code":"DOUCHE","label":"Douche","value":"1"},{"code":"DOUCHE_ITALIENNE","label":"Douche à l’italienne","value":"0"},{"code":"SDB_MEUBLE","label":"Meuble Vasque","value":"0"},{"code":"SDB_LAVABO","label":"Douche à l’italienne","value":"0"},{"code":"SDB_SECHE_SERVIETTE","label":"Sèche serviette","value":"0"},{"code":"SDB_WC","label":"WC","value":"1"}]},{"code":"WC","label":"WC","items":[{"code":"WC_SOL","label":"WC posé au sol","value":"1"}]},{"code":"CUISINE","label":"Cuisine","items":[{"code":"MEUBLE_CUISINE","label":"Meuble cuisine et électroménager","value":"Non"},{"code":"FABRICATION_MONTAGE","label":"Fabrication et montage","value":"Non"}]},{"code":"CHAUFFAGE_VENTILATION","label":"Chauffage et ventilation","items":[{"code":"CHAUDIERE_GAZ","label":"Chaudière gaz","value":"Non"},{"code":"SYSTEME_VENTILATION","label":"Système de ventilation","value":"Non"}]}]},{"code":"MUR_CLOISON","label":"Mur intérieur et cloison","categories":[{"code":"MONTAGE_CLOISON","label":"Montage de cloison","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"VERRIERE","label":"Verrière","value":"0 m"},{"code":"VERRIERE_MURET","label":"Verrière sur muret","value":"0 m"}]},{"code":"DEMOLITION_MUR","label":"Démolition de mur","items":[{"code":"CLOISON","label":"Cloison","value":"0 m"},{"code":"MUR_PORTEUR","label":"Mur porteur","value":"0 m"},{"code":"MUR_INDETERMINE","label":"Mur indéterminé","value":"0 m"}]}]},{"code":"MENUISERIE","label":"Menuiserie","categories":[{"code":"FENETRE","label":"Fenêtre","items":[{"code":"FENETRE_STANDARD","label":"Fenêtre","value":"0"},{"code":"FENETRE_TOIT","label":"Fenêtre de toit","value":"0"},{"code":"PORTE_FENETRE","label":"Porte fenêtre","value":"0"},{"code":"BAIE_VITREE","label":"Baie vitrée","value":"0"}]},{"code":"Porte","label":"Porte","items":[{"code":"PORTE_BATTANTE","label":"Porte battante","value":"0"},{"code":"PORTE_COULISSANTE","label":"Porte coulissante","value":"0"},{"code":"PORTE_ENTREE","label":"Porte d’entrée","value":"0"}]},{"code":"ESCALIER","label":"Escalier","items":[{"code":"ECALIER_DROIT","label":"Ecalier droit","value":"0"},{"code":"ESCALIER_MEUNIER","label":"Escalier de meunier","value":"0"},{"code":"ESCALIER_COLIMAÇON","label":"Escalier en colimaçon","value":"0"}]}]},{"code":"RAVALEMENT_FACADE","label":"Ravalement de façade","items":[{"code":"PEINTURE_EXTERIEURE","label":"Peinture extérieure","value":"0 m²"},{"code":"BARDAGE","label":"Bardage","value":"0 m²"},{"code":"ENDUIT_CREPI","label":"Enduit / Crépi","value":"0 m²"}]},{"code":"ISOLATION_THERMIQUE","label":"Isolation thermique","categories":[{"code":"ISOLATION_INTERIEURE","label":"Isolation intérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"},{"code":"COMBLES_AMENAGES","label":"Combles aménagés","value":"0 m²"},{"code":"COMBLES_PERDUS","label":"Combles perdus","value":"0 m²"}]},{"code":"ISOLATION_EXTERIEURE","label":"Isolation extérieure","items":[{"code":"MUR","label":"Mur","value":"0 m²"}]}]},{"code":"ELECTRICITE","label":"Electricité","items":[{"code":"ELECTRICITE_NORME","label":"Mise aux normes de l’électricité","value":"Non"}]}]},"tva":{"minimum":860,"maximum":1050},"total":{"minimum":9400,"maximum":11500},"parameters":{"nb_renover_cuisine":"1","s_cuisine":"10","nb_renover_sdb":"1","s_sdb":"01","nb_renover_wc":"1","s_wc":"20","nb_renover_buanderie":"0","s_buanderie":"0","nb_renover_chambre":"0","s_chbre":"0","nb_renover_salon":"1","s_salon":"5","nb_renover_entree":"0","s_couloir":"0","nb_renover_combles":"1","s_combles":"01","liste_travaux":[{"quantity":1,"categorie":"rvt","name":"NB_FUNNEL_MAISON_TRAVAUX_PEINTURE","label":"Peinture"},{"quantity":1,"categorie":"equip","name":"NB_FUNNEL_MAISON_TRAVAUX_SDB","label":"Salle de bain"}],"equipement_sdb":{"sdb_1":[{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_BAIGNOIRE","label":"Baignoire"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_DOUCHE","label":"Douche"},{"quantity":1,"name":"NB_FUNNEL_MAISON_EQUIP_SDB_WC","label":"Toilettes"}]},"equip_cuisine":"","rvt_cuisine":"","rvt_sdb":"","rvt_wc":"","rvt_buanderie":"","rvt_salon":"","rvt_chbre":"","rvt_entree":"","rvt_comble":"","longueur_a_creer_verriere":"0","longueur_a_creer_verriere_muret":"0","longueur_a_creer_cloison":"0","longueur_a_sup_mur":"0","longueur_a_sup_cloison":"0","longueur_a_sup_jnsp":"0","nb_funnel_maison_type_fenetre_fenetre":"0","nb_funnel_maison_type_fenetre_porte_fenetre":"0","nb_funnel_maison_type_fenetre_baie_vitree":"0","nb_funnel_maison_type_fenetre_fenetre_toit":"0","nb_funnel_maison_type_porte_battante":"0","nb_funnel_maison_type_porte_coulissante":"0","nb_funnel_maison_type_porte_entree":"0","nb_funnel_maison_type_escalier_droit":"0","nb_funnel_maison_type_escalier_colimacon":"0","nb_funnel_maison_type_escalier_echelle_meunier":"0","surface_bardage":"0","surface_enduit":"0","surface_peinture":"0","s_mur_iso_int":"0","s_mur_iso_ext":"0","type_iso_comble":"","nb_funnel_maison_equip_chauffage_chaudiere":"0","nb_funnel_maison_equip_chauffage_ballon_eau_chaude":"0","nb_funnel_maison_equip_chauffage_radiateur_eau":"0","nb_funnel_maison_equip_chauffage_radiateur_elec":"0","geographic_question":"75019"},"prestations":[{"id_prestation":"P0511","id":1413,"name":"PRESTA : Installation d\'une baignoire","code":"ELEM_PRESTA_INSTAL_BAIGNOIRE","total":{"minimum":1600,"maximum":1900}},{"id_prestation":"P0509","id":1411,"name":"PRESTA : Installation d\'une douche","code":"ELEM_PRESTA_INSTAL_DOUCHE","total":{"minimum":1700,"maximum":2100}},{"id_prestation":"P0508","id":1410,"name":"PRESTA : Installation d\'un WC","code":"ELEM_PRESTA_INSTAL_WC","total":{"minimum":1100,"maximum":1300}},{"id_prestation":"P0501","id":1407,"name":"PRESTA : Alimentation et évacuation des eaux","code":"ELEM_PRESTA_ALIMENTATION_EVACUATION_EAUX","total":{"minimum":810,"maximum":990}},{"id_prestation":"P0402","id":1405,"name":"PRESTA : Application d\'une peinture intérieure","code":"ELEM_PRESTA_APPLICATION_PEINTURE_INT","total":{"minimum":4210,"maximum":5220}}]}';

        TaroUtils.TaroChiffrage taroChiffrage = TaroUtils.getChiffrageFromJson(jsonString);
        Projet_LMSG__c projetLmsgData = TaroUtils.getDataNewProjetLMSGFromChiffrage(taroChiffrage, jsonString,  particulier.Id);
        insert projetLmsgData;
        projetLmsgData=[SELECT id, Chiffrage_minimum__c FROM Projet_LMSG__c WHERE id=:projetLmsgData.id];
        
        System.assertEquals(projetLmsgData.Chiffrage_minimum__c,9400);
        TaroUtils.TaroChiffrageDetail taroChiffrageDetail  = TaroUtils.callChiffrageDetail (projetLmsgData.Id);
        System.assertEquals(Integer.valueOf(taroChiffrageDetail.total.maximum),11500);
        System.assertEquals(Integer.valueOf(taroChiffrageDetail.postalCode.postalCode),95580);
        Test.stopTest();
    }
}